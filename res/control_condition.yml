version: "1.0.0"

# ============================================================
# Loop 0: Dissolved Oxygen Control
# ============================================================
# Sensor: DO750 (Slave 5) - Dissolved Oxygen Sensor
# Sources: O2_PCT (dissolved oxygen concentration)
# Actuators: TECO_VFD Slave 3, 4 (Aeration fans)
# ============================================================

DO750:
  instances:
    "5":
      use_default_controls: false
      controls:
        # ========== Emergency: DO < 1.5 mg/l → 60Hz ==========
        - name: "Loop0 - DO Emergency Low"
          code: "LOOP0_DO_EMERGENCY"
          priority: 0
          composite:
            any:
              - type: threshold
                sources: 
                  - O2_PCT
                operator: lt
                threshold: 1.5
                hysteresis: 0.5
                debounce_sec: 60.0
          policy:
            type: discrete_setpoint
          actions:
            - model: TECO_VFD
              slave_id: "3"
              type: set_frequency
              target: RW_HZ
              value: 60
              emergency_override: true
            - model: TECO_VFD
              slave_id: "4"
              type: set_frequency
              target: RW_HZ
              value: 60
              emergency_override: true

        # ========== Normal Control: Target 1.7 mg/l ==========
        # Speed up when DO < 1.7 mg/l
        - name: "Loop0 - DO Speed Up"
          code: "LOOP0_DO_SPEED_UP"
          priority: 50
          composite:
            any:
              - type: threshold
                sources:
                   - O2_PCT
                operator: lt
                threshold: 1.7
                hysteresis: 0.5
                debounce_sec: 0
          policy:
            type: incremental_linear
            condition_type: threshold
            sources:
               - O2_PCT
            gain_hz_per_unit: 1.0
          actions:
            - model: TECO_VFD
              slave_id: "3"
              type: adjust_frequency
              target: RW_HZ
            - model: TECO_VFD
              slave_id: "4"
              type: adjust_frequency
              target: RW_HZ

        # Slow down when DO > 1.7 mg/l
        - name: "Loop0 - DO Slow Down"
          code: "LOOP0_DO_SLOW_DOWN"
          priority: 60
          composite:
            any:
              - type: threshold
                sources:
                   - O2_PCT
                operator: gt
                threshold: 1.7
                hysteresis: 0.5
                debounce_sec: 0
          policy:
            type: incremental_linear
            condition_type: threshold
            sources:
               - O2_PCT
            gain_hz_per_unit: -1.0
          actions:
            - model: TECO_VFD
              slave_id: "3"
              type: adjust_frequency
              target: RW_HZ
            - model: TECO_VFD
              slave_id: "4"
              type: adjust_frequency
              target: RW_HZ

# ============================================================
# Configuration Notes
# ============================================================
# 1. Control Strategy:
#    - Emergency (Priority 0): DO < 1.5 mg/l → Full speed 60Hz
#    - Normal control: Target 1.7 mg/l with incremental adjustments
#      - Below target → +1 Hz per cycle (increase aeration)
#      - Above target → -1 Hz per cycle (decrease aeration)
#
# 2. Hysteresis & Debounce:
#    - Hysteresis: 0.5 mg/l (prevents oscillation near thresholds)
#    - Emergency debounce: 60s (confirms low DO before emergency action)
#    - Normal debounce: 0s (immediate response to changes)
#
# 3. Emergency Override:
#    - Enabled for emergency condition
#    - Bypasses frequency constraints to ensure 60Hz can be reached
#
# 4. Evaluation Cycle:
#    - Default: Every 10 seconds (configurable in system config)
#    - Adjustments are ±1 Hz per evaluation cycle
#
# 5. Actuator Details:
#    - VFD Slave 3: Aeration Fan 1 (曝氣機1)
#    - VFD Slave 4: Aeration Fan 2 (曝氣機2)
#    - Both fans controlled simultaneously by same conditions
#    - Frequency range: 48-60 Hz (defined in constraint config)
#
# 6. Alert Conditions (handled separately):
#    - O2_PCT < 1.5 mg/l (emergency low)
#    - O2_PCT > 3.0 mg/l (warning high)