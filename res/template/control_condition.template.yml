version: "0.1.5.0"


SD400:
  default_controls: []
  instances:
    "8":
      use_default_controls: false
      controls:
        # ========================================
        # Priority 0: Emergency - Below 24°C shutdown both fans
        # ========================================
        - name: "Emergency Low Temperature Fan Shutdown"
          code: "FAN_EMERGENCY_OFF"
          priority: 0
          blocking: true
          composite:
            any:
              - type: threshold
                sources: [AIn04]
                operator: lt
                threshold: 24.0
                hysteresis: 1.0
                debounce_sec: 10.0
          policy:
            type: discrete_setpoint
          actions:
            - model: TECO_VFD
              slave_id: "5"
              type: turn_off
              target: RW_ON_OFF
            - model: TECO_VFD
              slave_id: "6"
              type: turn_off
              target: RW_ON_OFF

        # ========================================
        # Priority 1: Chilled Water Pump Temperature Difference Control (4°C)
        # ========================================
        - name: "Chilled Water Pump Increase Frequency"
          code: "CHWP_TEMP_DIFF_INC"
          priority: 10
          composite:
            any:
              - type: difference
                sources: [AIn03, AIn02]
                operator: gt
                threshold: 4.0
                abs: false
                hysteresis: 0.3
                debounce_sec: 5.0
          policy:
            type: incremental_linear
            condition_type: difference
            sources: [AIn03, AIn02]
            gain_hz_per_unit: 2.0
          actions:
            - model: TECO_VFD
              slave_id: "4"
              type: adjust_frequency
              target: RW_HZ

        - name: "Chilled Water Pump Decrease Frequency"
          code: "CHWP_TEMP_DIFF_DEC"
          priority: 10
          composite:
            any:
              - type: difference
                sources: [AIn03, AIn02]
                operator: lt
                threshold: 4.0
                abs: false
                hysteresis: 0.3
                debounce_sec: 5.0
          policy:
            type: incremental_linear
            condition_type: difference
            sources: [AIn03, AIn02]
            gain_hz_per_unit: -2.0
          actions:
            - model: TECO_VFD
              slave_id: "4"
              type: adjust_frequency
              target: RW_HZ

        # ========================================
        # Priority 1: Cooling Water Pump Temperature Difference Control (2°C)
        # ========================================
        - name: "Cooling Water Pump Increase Frequency"
          code: "CWP_TEMP_DIFF_INC"
          priority: 10
          composite:
            any:
              - type: difference
                sources: [AIn05, AIn04]
                operator: gt
                threshold: 2.0
                abs: false
                hysteresis: 0.3
                debounce_sec: 5.0
          policy:
            type: incremental_linear
            condition_type: difference
            sources: [AIn05, AIn04]
            gain_hz_per_unit: 2.0
          actions:
            - model: TECO_VFD
              slave_id: "3"
              type: adjust_frequency
              target: RW_HZ

        - name: "Cooling Water Pump Decrease Frequency"
          code: "CWP_TEMP_DIFF_DEC"
          priority: 10
          composite:
            any:
              - type: difference
                sources: [AIn05, AIn04]
                operator: lt
                threshold: 2.0
                abs: false
                hysteresis: 0.3
                debounce_sec: 5.0
          policy:
            type: incremental_linear
            condition_type: difference
            sources: [AIn05, AIn04]
            gain_hz_per_unit: -2.0
          actions:
            - model: TECO_VFD
              slave_id: "3"
              type: adjust_frequency
              target: RW_HZ

        # ========================================
        # Priority 1: Fan 1 - Turn on at 27°C (只開啟，不設頻率)
        # ========================================
        - name: "Fan 1 Turn On at 27C"
          code: "FAN1_ON_27C"
          priority: 10
          composite:
            any:
              - type: threshold
                sources: [AIn04]
                operator: gte
                threshold: 27.0
                hysteresis: 0.5
                debounce_sec: 5.0
          policy:
            type: discrete_setpoint
          actions:
            - model: TECO_VFD
              slave_id: "5"
              type: turn_on
              target: RW_ON_OFF

        # ========================================
        # Priority 2: Fan 2 - Turn on at 28°C (只開啟，不設頻率)
        # ========================================
        - name: "Fan 2 Turn On at 28C"
          code: "FAN2_ON_28C"
          priority: 20
          composite:
            any:
              - type: threshold
                sources: [AIn04]
                operator: gte
                threshold: 28.0
                hysteresis: 0.5
                debounce_sec: 5.0
          policy:
            type: discrete_setpoint
          actions:
            - model: TECO_VFD
              slave_id: "6"
              type: turn_on
              target: RW_ON_OFF

        # ========================================
        # Priority 2: Fan 2 - Turn off between 27-28°C
        # ========================================
        - name: "Fan 2 Turn Off Between 27-28C"
          code: "FAN2_OFF_27_28C"
          priority: 20
          composite:
            any:
              - type: threshold
                sources: [AIn04]
                operator: between
                min: 27.0
                max: 28.0
                hysteresis: 0.5
                debounce_sec: 3.0
          policy:
            type: discrete_setpoint
          actions:
            - model: TECO_VFD
              slave_id: "6"
              type: turn_off
              target: RW_ON_OFF

        # ========================================
        # Priority 3: Both fans set to 35Hz when temp < 30°C
        # ========================================
        - name: "Fans Set 35Hz Below 30C"
          code: "FANS_35HZ_BELOW_30C"
          priority: 30
          composite:
            any:
              - type: threshold
                sources: [AIn04]
                operator: lt
                threshold: 30.0
                hysteresis: 0.5
                debounce_sec: 5.0
          policy:
            type: discrete_setpoint
          actions:
            - model: TECO_VFD
              slave_id: "5"
              type: set_frequency
              target: RW_HZ
              value: 35
            - model: TECO_VFD
              slave_id: "6"
              type: set_frequency
              target: RW_HZ
              value: 35

        # ========================================
        # Priority 3: Both fans adjust frequency when temp >= 30°C AND approach >= 3°C
        # ========================================
        - name: "Fans Adjust Frequency Above 30C with Approach Check"
          code: "FANS_ADJUST_FREQUENCY_ABOVE_30C"
          priority: 30
          composite:
            all:
              - type: threshold
                sources: [AIn04]
                operator: gte
                threshold: 30.0
                hysteresis: 0.5
                debounce_sec: 5.0
              - type: difference
                sources: [AIn04, AIn07]
                operator: gte
                threshold: 3.0
                abs: false
                hysteresis: 0.3
                debounce_sec: 5.0
          policy:
            type: incremental_linear
            condition_type: threshold
            sources: [AIn04]
            gain_hz_per_unit: 2.0
          actions:
            - model: TECO_VFD
              slave_id: "5"
              type: adjust_frequency
              target: RW_HZ
            - model: TECO_VFD
              slave_id: "6"
              type: adjust_frequency
              target: RW_HZ

TECO_VFD:
  instances:
    "7":
      use_default_controls: false
      controls:
        - name: "VFD Low Frequency Auto Start"
          code: "VFD_LOW_FREQ_START"
          priority: 80
          composite:
            any:
              - type: threshold
                sources: [HZ]      
                operator: lt
                threshold: 29.0
                hysteresis: 1.0
                debounce_sec: 5.0
          policy:
            type: discrete_setpoint
          actions:
            - model: TECO_VFD
              slave_id: "7"
              type: turn_on
              target: RW_ON_OFF
            - model: TECO_VFD
              slave_id: "7"
              type: set_frequency
              target: RW_HZ
              value: 60.0
    "3":
      use_default_controls: false
      controls:
        - name: "Auxiliary Pump Fast Stepdown"
          code: "AUX_PUMP_FREQ_STEPDOWN_1H"
          priority: 60
          composite:
            any:
              - type: time_elapsed
                interval_hours: 1.0  # Every hour
          policy:
            type: discrete_setpoint
          actions:
            - model: LITEON_EVO6800
              slave_id: "3"
              type: adjust_frequency
              target: RW_HZ
              value: -2.0  # Smaller adjustment, more frequent
          