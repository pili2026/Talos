# ============================================================
# Talos Alert Condition Configuration Template
# Version: 1.1.0 (with schedule_expected_state support)
# ============================================================
# This template demonstrates all available alert types and configurations.
# Copy and modify sections as needed for your deployment.
# ============================================================

version: "1.1.0"

# ============================================================
# EXAMPLE 1: Threshold Alerts (Single Source)
# ============================================================
# Use case: Monitor single parameter against fixed threshold
# Supported devices: Any device with readable parameters
# ============================================================

# Example: Temperature monitoring
ADAM-4117:
  instances:
    "10":
      use_default_alerts: false
      alerts:
        # Single threshold alert
        - code: "TEMP_HIGH"
          name: "Temperature High Warning"
          sources: ["AIn01"]  # Single source (must be list)
          type: "threshold"
          condition: "gt"  # gt, lt, eq, gte, lte, neq
          threshold: 35.0
          severity: "WARNING"  # CRITICAL, ERROR, WARNING, INFO
          message: "Temperature exceeds 35°C"  # Optional custom message

# Example: Dissolved oxygen monitoring
DO750:
  instances:
    "5":
      use_default_alerts: false
      alerts:
        # Critical low threshold
        - code: "DO_CRITICAL_LOW"
          name: "Dissolved Oxygen Critical Low"
          sources: ["O2_PCT"]
          type: "threshold"
          condition: "lt"
          threshold: 1.5
          severity: "CRITICAL"
          message: "DO critically low (< 1.5 mg/l). Emergency action required."
        
        # Warning high threshold
        - code: "DO_WARNING_HIGH"
          name: "Dissolved Oxygen High"
          sources: ["O2_PCT"]
          type: "threshold"
          condition: "gt"
          threshold: 3.0
          severity: "WARNING"
          message: "DO level high (> 3.0 mg/l). Check aeration system."

# ============================================================
# EXAMPLE 2: Aggregate Alerts (Multiple Sources)
# ============================================================
# Use case: Monitor combined/averaged values from multiple sensors
# Types: average, sum, min, max
# Requires: At least 2 sources
# ============================================================

ADAM-4117:
  instances:
    "12":
      use_default_alerts: false
      alerts:
        # Average temperature alert
        - code: "AVG_TEMP_HIGH"
          name: "Average Temperature High"
          sources: ["AIn02", "AIn03"]  # Multiple sources required
          type: "average"
          condition: "gt"
          threshold: 40.0
          severity: "CRITICAL"
          message: "Average temperature exceeds 40°C"
        
        # Sum of currents alert
        - code: "TOTAL_CURRENT_HIGH"
          name: "Total Current High"
          sources: ["AIn04", "AIn05", "AIn06"]
          type: "sum"
          condition: "gt"
          threshold: 100.0
          severity: "WARNING"
          message: "Total current exceeds 100A"
        
        # Minimum temperature alert
        - code: "MIN_TEMP_LOW"
          name: "Minimum Temperature Low"
          sources: ["AIn02", "AIn03"]
          type: "min"
          condition: "lt"
          threshold: 20.0
          severity: "WARNING"
          message: "Minimum temperature below 20°C"
        
        # Maximum temperature alert
        - code: "MAX_TEMP_HIGH"
          name: "Maximum Temperature High"
          sources: ["AIn02", "AIn03", "AIn04"]
          type: "max"
          condition: "gt"
          threshold: 45.0
          severity: "CRITICAL"
          message: "Maximum temperature exceeds 45°C"

# ============================================================
# EXAMPLE 3: Schedule Expected State Alerts (Time-Based)
# ============================================================
# Use case: Detect devices running outside scheduled work hours
# Requirements:
#   - TimeControl must be enabled with work_hours configured
#   - Device must have readable state parameter (e.g., RW_ON_OFF)
#   - Only applicable to controllable devices (VFD, pumps, etc.)
# Behavior:
#   - No alert during work_hours (device allowed to run)
#   - Alert triggered outside work_hours if state != expected_state
# ============================================================

# Example: Blower/pump shutdown monitoring
TECO_VFD:
  instances:
    "1":
      use_default_alerts: false
      alerts:
        # Alert if running after hours
        - code: "BLOWER_AFTER_HOURS"
          name: "Blower Running After Hours"
          sources: ["RW_ON_OFF"]  # Must be exactly 1 source (state parameter)
          type: "schedule_expected_state"
          expected_state: 0  # 0/"off" = device should be OFF, 1/"on" = device should be ON
          use_work_hours: true  # Use time_condition work_hours (default: true)
          severity: "WARNING"
          message: "Blower is running outside scheduled work hours"

# Example: Critical equipment must run 24/7
COOLING_SYSTEM:
  instances:
    "1":
      use_default_alerts: false
      alerts:
        # Alert if stopped during any period
        - code: "COOLING_STOPPED"
          name: "Cooling System Stopped"
          sources: ["RW_ON_OFF"]
          type: "schedule_expected_state"
          expected_state: 1  # Expect ON (device must always run)
          severity: "CRITICAL"
          message: "Critical: Cooling system has stopped"

# ============================================================
# EXAMPLE 4: Mixed Alert Strategies
# ============================================================
# Use case: Combine different alert types for comprehensive monitoring
# Strategy: Average for trends + individual for redundancy + schedule for compliance
# ============================================================

ADAM-4117:
  instances:
    "14":
      use_default_alerts: false
      alerts:
        # Primary: Average temperature trend
        - code: "FERMENTER_AVG_OVERHEAT"
          name: "Fermenter Average Temperature High"
          sources: ["AIn05", "AIn06"]
          type: "average"
          condition: "gt"
          threshold: 40.0
          severity: "CRITICAL"
          message: "Fermenter average temperature exceeds 40°C"
        
        # Redundancy: Individual sensor failures
        - code: "FERMENTER_SENSOR1_OVERHEAT"
          name: "Fermenter Temperature Sensor 1 High"
          sources: ["AIn05"]
          type: "threshold"
          condition: "gt"
          threshold: 42.0
          severity: "WARNING"
          message: "Fermenter sensor 1 exceeds 42°C"
        
        - code: "FERMENTER_SENSOR2_OVERHEAT"
          name: "Fermenter Temperature Sensor 2 High"
          sources: ["AIn06"]
          type: "threshold"
          condition: "gt"
          threshold: 42.0
          severity: "WARNING"
          message: "Fermenter sensor 2 exceeds 42°C"

TECO_VFD:
  instances:
    "2":
      use_default_alerts: false
      alerts:
        # Operational: Current overload
        - code: "VFD_OVERCURRENT"
          name: "VFD Current High"
          sources: ["RW_CURRENT"]
          type: "threshold"
          condition: "gt"
          threshold: 10.0
          severity: "WARNING"
          message: "VFD current exceeds 10A"
        
        # Compliance: Schedule monitoring
        - code: "VFD_AFTER_HOURS"
          name: "VFD Running After Hours"
          sources: ["RW_ON_OFF"]
          type: "schedule_expected_state"
          expected_state: 0
          severity: "WARNING"
          message: "VFD is running outside work hours"

# ============================================================
# EXAMPLE 5: Using Default Alerts
# ============================================================
# Use case: Apply same alerts to multiple device instances
# ============================================================

SD400:
  # Define alerts once at model level
  default_alerts:
    - code: "TEMP_HIGH_DEFAULT"
      name: "Temperature High (Default)"
      sources: ["AIn01"]
      type: "threshold"
      condition: "gt"
      threshold: 50.0
      severity: "WARNING"

  instances:
    # Instance 3: Use default alerts
    "3":
      use_default_alerts: true
      display_name: "Temperature Sensor A"
    
    # Instance 5: Override with custom alerts
    "5":
      use_default_alerts: false
      display_name: "Temperature Sensor B"
      alerts:
        - code: "CUSTOM_TEMP_HIGH"
          name: "Custom Temperature High"
          sources: ["AIn01"]
          type: "threshold"
          condition: "gt"
          threshold: 45.0  # Different threshold
          severity: "CRITICAL"
    
    # Instance 7: No alerts
    "7":
      use_default_alerts: false
      display_name: "Temperature Sensor C (No Alerts)"

# ============================================================
# Configuration Guidelines
# ============================================================
#
# 1. Alert Types:
#    - threshold: Single source, fixed threshold
#    - average: Average of multiple sources
#    - sum: Sum of multiple sources
#    - min: Minimum of multiple sources
#    - max: Maximum of multiple sources
#    - schedule_expected_state: Time-based state monitoring
#
# 2. Condition Operators:
#    - gt: Greater than (>)
#    - gte: Greater than or equal (>=)
#    - lt: Less than (<)
#    - lte: Less than or equal (<=)
#    - eq: Equal (==)
#    - neq: Not equal (!=)
#
# 3. Severity Levels (highest to lowest):
#    - CRITICAL: Immediate action required, emergency response
#    - ERROR: Serious issue, requires prompt attention
#    - WARNING: Attention needed, preventive action
#    - INFO: Informational only, no action required
#
# 4. State Management (automatic):
#    - NORMAL → TRIGGERED: First violation detected (notification sent)
#    - TRIGGERED → ACTIVE: Continuous violation (no notification)
#    - ACTIVE → RESOLVED: Condition recovered (notification sent)
#    - RESOLVED → NORMAL: Cleanup (no notification)
#
# 5. Schedule Expected State Requirements:
#    - TimeControl must be configured in time_condition.yml
#    - Device must have work_hours defined (or use default)
#    - Only applicable to devices with state parameters (RW_ON_OFF)
#    - Alert triggers when: (outside work_hours) AND (state != expected_state)
#
# 6. expected_state Values:
#    - 0 or "off": Device should be OFF
#    - 1 or "on": Device should be ON
#    - Recommendation: Use 0 for most shutdown monitoring
#                     Use 1 for critical 24/7 equipment
#
# 7. Best Practices:
#    a. Redundancy Strategy:
#       - Use average alerts for overall trends (CRITICAL)
#       - Use individual alerts for single sensor failures (WARNING)
#       - Prevents missing failures when one sensor is offline
#
#    b. Threshold Tuning:
#       - Set WARNING thresholds before CRITICAL thresholds
#       - Leave buffer between WARNING and CRITICAL (e.g., 40°C → 42°C)
#       - Adjust based on operational experience
#
#    c. Message Clarity:
#       - Include context (what, why, action needed)
#       - Reference specific sensors/equipment
#       - Use consistent terminology
#
#    d. Schedule Monitoring:
#       - Apply to non-essential equipment only
#       - Exclude critical 24/7 systems (cooling, safety)
#       - Coordinate with operational schedules
#
# 8. Example Notification Messages:
#    TRIGGERED (threshold):
#      "[WARNING] Temperature High: AIn01=35.2 violates gt 35.0"
#    
#    TRIGGERED (aggregate):
#      "[CRITICAL] Average Temperature High: average(AIn02, AIn03)=40.5 violates gt 40.0"
#    
#    TRIGGERED (schedule):
#      "[WARNING] Blower Running After Hours: RW_ON_OFF=ON (expected OFF) during shutdown period"
#    
#    RESOLVED:
#      "[RESOLVED] Temperature High: AIn01=34.8 returned to normal (threshold: 35.0)"
#      "[RESOLVED] Blower Running After Hours: RW_ON_OFF=OFF returned to expected state"
#
# 9. Integration Notes:
#    - Alerts work alongside Control Conditions (separate systems)
#    - Control emergency conditions execute automatically
#    - Alerts provide notifications to operators
#    - Both systems contribute to overall safety
#
# 10. Common Pitfalls:
#     X Using single source for aggregate types (validation error)
#     X Forgetting to wrap single source in list: source: "AIn01" (use sources: ["AIn01"])
#     X Using schedule_expected_state without TimeControl configured
#     X Applying schedule alerts to AI/DI modules (they have no state)
#     X Setting threshold too close to normal operating range (false alarms)
#
# ============================================================
# Quick Start Checklist
# ============================================================
# [ ] Identify devices and parameters to monitor
# [ ] Determine appropriate alert types (threshold/aggregate/schedule)
# [ ] Set severity levels based on operational impact
# [ ] Configure work_hours in time_condition.yml (if using schedule alerts)
# [ ] Test alerts in non-production environment
# [ ] Tune thresholds based on actual data
# [ ] Document alert handling procedures
# [ ] Review and adjust alert fatigue (too many notifications)
#
# ============================================================
# Support & Documentation
# ============================================================
# For more information:
# - Alert Specification: docs/Talos_Alert_Condition_Specification.md
# - Time Control: docs/Time_Control___Scheduling___Capability_Translation_Specification.md
# - State Management: evaluator/alert_state_manager.py
# - Configuration Schema: schema/alert_schema.py
#
# ============================================================